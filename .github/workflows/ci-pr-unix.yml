###############################################################
#
# Copyright (Â©) 2025 International Color Consortium.
# All rights reserved.
# https://color.org
#
#
# Intent: Unix/Linux and macOS multi-compiler build and test pipeline for PR validation
#
# Last Updated: 14-DEC-2025 1810Z by David Hoyt 
#               Refactor workflow with sanitization
#               Improved job names
#
#
#
#
#
#
#
###############################################################

name: "ci-pr-unix"

permissions:
  contents: read
  pull-requests: read

on:
  # Allow manual runs
  workflow_dispatch:

  # Allow reuse by other workflows
  workflow_call:
    inputs:
      os-list:
        description: "List of operating systems"
        required: false
        default: '["ubuntu-latest", "macos-latest"]'
        type: string
      build-types:
        description: "Build types"
        required: false
        default: '["Release", "Debug"]'
        type: string
      compilers:
        description: "Compiler list"
        required: false
        default: '["gcc", "clang"]'
        type: string

concurrency:
  group: child-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ github.job }}
  cancel-in-progress: true

env:
  GH_REPO: ${{ github.repository }}
  GH_NO_UPDATE_NOTIFIER: 1
  GH_PROMPT_DISABLED: 1
  RUN_URL: ${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}
  PR: ${{ github.event.number }}

jobs:
  build:
    name: "${{ matrix.os }} â€¢ ${{ matrix.compiler }} â€¢ ${{ matrix.build_type }}"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    defaults:
      run:
        shell: bash --noprofile --norc {0}

    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJson(inputs.os-list || '["ubuntu-latest", "macos-latest"]') }}
        compiler: ${{ fromJson(inputs.compilers || '["gcc", "clang"]') }}
        build_type: ${{ fromJson(inputs.build-types || '["Release", "Debug"]') }}
        exclude:
          - os: macos-latest
            compiler: gcc

    steps:
      - name: Validate matrix inputs
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

          OS="${{ matrix.os }}"
          COMP="${{ matrix.compiler }}"
          BT="${{ matrix.build_type }}"

          case "$OS" in
            ubuntu-latest|macos-latest) ;;
            *) echo "ERROR: invalid matrix.os: '$OS'. Allowed: ubuntu-latest, macos-latest"; exit 1 ;;
          esac
          case "$COMP" in
            gcc|clang) ;;
            *) echo "ERROR: invalid compiler: '$COMP'. Allowed: gcc, clang"; exit 1 ;;
          esac
          case "$BT" in
            Release|Debug) ;;
            *) echo "ERROR: invalid build type: '$BT'. Allowed: Release, Debug"; exit 1 ;;
          esac

      - name: Check out Repository
        uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          fetch-depth: 0

      - name: Print the PR Branch Details
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          echo "Triggered by:  ${{ github.event_name }}"
          echo "Base branch:   ${{ github.base_ref }}"
          echo "Head branch:   ${{ github.head_ref }}"
          echo "Commit SHA:    ${{ github.event.pull_request.head.sha }}"
          echo "Build Type:    ${{ matrix.build_type }}"
          echo "Compiler:      ${{ matrix.compiler }}"
          echo "OS:            ${{ matrix.os }}"

          {
            echo "### PR Branch Details"
            echo ""
            echo "**Triggered by:**  ${{ github.event_name }}"
            echo "**Base branch:**   ${{ github.base_ref }}"
            echo "**Head branch:**   ${{ github.head_ref }}"
            echo "**Commit SHA:**    ${{ github.event_pull_request.head.sha }}"
            echo "**Build Type:**    ${{ matrix.build_type }}"
            echo "**Compiler:**      ${{ matrix.compiler }}"
            echo "**OS:**            ${{ matrix.os }}"
          } >> $GITHUB_STEP_SUMMARY
      - name: Install Build Dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential cmake gcc g++ clang clang-tools \
            libpng-dev libxml2-dev libtiff-dev \
            nlohmann-json3-dev libwxgtk3.2-dev wx-common \
            python3 python3-pip curl git llvm

      - name: Install Build Dependencies (macOS)
        if: runner.os == 'macOS'
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          brew install cmake llvm wxwidgets libpng libtiff libxml2 nlohmann-json

      - name: Set Compiler Environment Variables
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            echo "CC=gcc" >> $GITHUB_ENV
            echo "CXX=g++" >> $GITHUB_ENV
          else
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          fi

      - name: Configure with CMake
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          echo "Configuring CMake project..."
          mkdir -p Build
          cd Build
          cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                -DCMAKE_C_COMPILER=$CC \
                -DCMAKE_CXX_COMPILER=$CXX \
                 Cmake
          echo "::group::CMake Cache"
          cat CMakeCache.txt || true
          echo "::endgroup::"

      - name: Build Project
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          echo "Start build..."
          cd Build
          echo "Compiler: $CC ($($CC --version | head -n 1))"
          echo "CMake build type: ${{ matrix.build_type }}"
          make -j$(nproc || sysctl -n hw.logicalcpu)

      - name: Create Profiles
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          echo "Creating profiles..."
          cd Testing
          echo "=== Updating PATH ==="
          for d in ../Build/Tools/*; do
          [ -d "$d" ] && export PATH="$(realpath "$d"):$PATH"
          done 
          sh CreateAllProfiles.sh
          sh RunTests.sh
          find . -iname "*.icc" | wc -l 
          echo "Build complete."

      - name: Generate PR Unix Summary Report
        if: always()
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          # Use canonical sanitization from .github/scripts/sanitize-sed.sh
          if [ ! -r .github/scripts/sanitize-sed.sh ]; then
            echo "ERROR: .github/scripts/sanitize-sed.sh not found or not readable" >&2
            exit 1
          fi
          source .github/scripts/sanitize-sed.sh
          SANITIZED_OS=$(sanitize_line "${{ matrix.os }}")
          SANITIZED_COMPILER=$(sanitize_line "${{ matrix.compiler }}")
          SANITIZED_BUILD_TYPE=$(sanitize_line "${{ matrix.build_type }}")
          echo "## ðŸ§± ci-pr-unix Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **OS:**         $SANITIZED_OS" >> $GITHUB_STEP_SUMMARY
          echo "- **Compiler:**   $SANITIZED_COMPILER" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type:** $SANITIZED_BUILD_TYPE" >> $GITHUB_STEP_SUMMARY

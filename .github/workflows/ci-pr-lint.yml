###############################################################
#
# Copyright (Â©) 2025 International Color Consortium. 
#                 All rights reserved. 
#                 https://color.org
#
#
# Intent: Static code analysis and linting
# Last Updated: 02-JAN-2025 2100Z by David Hoyt 
# 
#               Change git depth, other changes
#
#
#
#
#
#
#
###############################################################

name: "ci-pr-lint"

permissions:
  contents: read
  pull-requests: read

on:
  # Allow manual trigger
  workflow_dispatch:

  # Allow other workflows to call this
  workflow_call:
    inputs:
      ubuntu-version:
        description: "Ubuntu version for runner"
        required: false
        default: "ubuntu-latest"
        type: string

jobs:
  build-linux:
    name: Lint on ${{ inputs.ubuntu-version || 'ubuntu-latest' }}
    runs-on: ${{ inputs.ubuntu-version || 'ubuntu-latest' }}
    timeout-minutes: 30
    steps:

      # --- Bump any Self-Hosted ---
      - name: Validate ubuntu-version input
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          case "${{ inputs.ubuntu-version }}" in
            ubuntu-latest|ubuntu-22.04|ubuntu-24.04|"")
              ;;
            *)
              echo "ERROR: Invalid runner: '${{ inputs.ubuntu-version }}' â€” blocked." >&2
              exit 1
              ;;
          esac

      - uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5
        with:
          fetch-depth: 0
          # Disable unsafe fetch options
          persist-credentials: false

      - name: Checkout base commit (trusted sanitizers)
        uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5
        with:
          # For workflow_call from ci-pr-action: use github.sha (the base branch)
          # For pull_request: use github.event.pull_request.base.sha
          # For workflow_dispatch: use github.sha
          ref: ${{ github.event.pull_request.base.sha || github.sha }}
          path: base
          fetch-depth: 1
          persist-credentials: false

      - name: Set up Git anonymous identity
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Verify remote origin URL (opt out of malicious git configs)
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          origin_url=$(git remote get-url origin || true)
          echo "Remote origin: $origin_url"
          # Enforce that origin points to the expected GitHub repository for this workflow run
          expected="https://github.com/${{ github.repository }}.git"
          # Allow both HTTPS and git@ forms if needed
          if [[ "$origin_url" != "$expected" && "$origin_url" != "${expected%.git}" && "$origin_url" != "git@github.com:InternationalColorConsortium/iccDEV.git" ]]; then
            echo "Origin URL mismatch: expected $expected, ${expected%.git}, or git@github.com:InternationalColorConsortium/iccDEV.git, got $origin_url" >&2
            exit 1
          fi

      - name: Install Linux dependencies
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential cmake gcc g++ clang clang-tools \
            cppcheck clang-format pkg-config \
            libpng-dev libxml2-dev libtiff-dev \
            nlohmann-json3-dev libwxgtk3.2-dev wx-common \
            python3 python3-pip curl git llvm

      - id: diffcheck
        name: diffcheck for file changes
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

          git show --stat --pretty=format:"Commit: %H%nAuthor: %an%nDate: %ad%n" HEAD

          # If not a pull_request event (e.g., workflow_dispatch or workflow_call),
          # skip source diff checking and mark as non-source change.
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "Non-PR event (${{ github.event_name }}) â€” skipping source diff check" >&2
            echo "no_src_changes=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          base_ref="${{ github.base_ref }}"

          # Avoid fetching refs from user-controllable inputs like ($base_ref)
          case "$base_ref" in master)
              ;;
            *)
              echo "Ref blocked or unsupported: $base_ref" >&2
              echo "no_src_changes=true" >> "$GITHUB_OUTPUT"
              exit 0
              ;;
          esac

          # Fetch enough history to find merge base
          git -c protocol.version=2 fetch --no-tags origin "${base_ref}" --depth=50

          # Case-insensitive extension match (c/h/cpp variants)
          # Use three-dot syntax to show changes since merge-base
           git diff --name-only "origin/${base_ref}...HEAD" \
             | tr -cd '[:alnum:]./\-_\n' \
             | grep -E '\.(cpp|cxx|cc|h|hpp)$' \
             | tr '\n' '\0' > changed_files.txt

           changed_file_count="$(xargs -0 -n1 < changed_files.txt | wc -l)"

           if [ "$changed_file_count" -eq 0 ]; then
             echo "no_src_changes=true" >> "$GITHUB_OUTPUT"
           else
             echo "no_src_changes=false" >> "$GITHUB_OUTPUT"
           fi
          
      - name: Configure and build
        if: ${{ steps.diffcheck.outputs.no_src_changes == 'false' }}
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
  
          mkdir -p Build
          cd Build
          cmake Cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          make
          cd ..

      - name: Run cppcheck
        if: ${{ steps.diffcheck.outputs.no_src_changes == 'false' }}
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
  
          mkdir -p lint_reports
  
          echo "Running cppcheck on modified source files..."
  
          # --- SECURITY: null-delimited xargs ---
          : > lint_reports/cppcheck.txt
          xargs -0 cppcheck \
            --enable=warning,performance,portability \
            --std=c++17 \
            --output-file=lint_reports/cppcheck.txt \
            < changed_files.txt || true

      - name: Run clang-tidy
        if: ${{ steps.diffcheck.outputs.no_src_changes == 'false' }}
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          mkdir -p lint_reports
  
          # --- clang-tidy ---
          : > lint_reports/clang_tidy.txt
          xargs -0 run-clang-tidy \
            -p Build \
            -checks='modernize-*,readability-*,cppcoreguidelines-*,clang-analyzer-core.*,clang-analyzer-security.*,clang-analyzer-alpha.core.*,clang-analyzer-alpha.security.*' \
            < changed_files.txt \
            | tee lint_reports/clang_tidy.txt || true

      - name: Skip lint (no source changes)
        if: ${{ steps.diffcheck.outputs.no_src_changes == 'true' }}
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          mkdir -p lint_reports
          echo "No .cpp/.h changes detected; skipping lint." > lint_reports/cppcheck.txt
          : > lint_reports/clang_tidy.txt

      - uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: lint-reports
          path: lint_reports/


      - name: Generate GitHub summary
        if: always()
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          
          # Load trusted canonical sanitizer functions from base commit
          TRUSTED_SANITIZER="$GITHUB_WORKSPACE/base/.github/scripts/sanitize-sed.sh"
          if [[ -f "$TRUSTED_SANITIZER" ]]; then
            # shellcheck disable=SC1090
            source "$TRUSTED_SANITIZER"
          else
            # Fallback sanitizer
            escape_html() {
              local s="$1"
              s="${s//&/&amp;}"
              s="${s//</&lt;}"
              s="${s//>/&gt;}"
              s="${s//\"/&quot;}"
              s="${s//\'/&#39;}"
              printf '%s' "$s"
            }
            sanitize_line() { escape_html "$1"; }
          fi
          
          echo "## ðŸ§¹ Lint Report Summary" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.diffcheck.outputs.no_src_changes }}" == "true" ]; then
            echo "ðŸŸ¦ Skipped â€” no modified source files detected." >> $GITHUB_STEP_SUMMARY
          elif [ -s lint_reports/cppcheck.txt ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            # Sanitize each line properly - avoid subshell issues
            while IFS= read -r line; do
              safe_line=$(sanitize_line "$line")
              echo "$safe_line"
            done < <(tail -n 30 lint_reports/cppcheck.txt) >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No cppcheck warnings or errors detected." >> $GITHUB_STEP_SUMMARY
          fi

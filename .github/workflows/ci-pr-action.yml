###############################################################
#
# Copyright (¬©) 2025 International Color Consortium. 
#                 All rights reserved. 
#                 https://color.org
#
#
## Intent: iccDEV ci-pr-action
#
## Last Updated: 02-JAN-2026 2100Z by David Hoyt
##               Fix "no merge base" error in diffcheck step
#                Consider Copilot Review
#                Review GitHub Best Practice & Security Guides
#
# Last Updated: 17-DEC-2025 0030Z by David Hoyt 
#               Refactor workflow with sanitization
#               Improved job names
#    
#
#
#  Note: We continue to monitor the ci-pr- labels for issues
#        Add TODO Issues with Comments, Suggestions & Feedback
#
#
#
###############################################################

name: "ci-pr-action"

permissions:
  contents: read
  pull-requests: read
  # Avoid unnecessary permissions; do not add write permissions.

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

concurrency:
  group: "ci-pr-${{ github.workflow }}-${{ github.event.pull_request.number }}"
  cancel-in-progress: true

jobs:
  detect-src:
    name: üß≠ Welcome to iccDEV
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    outputs:
      src_changed: ${{ steps.diffcheck.outputs.src_changed }}

    steps:
      - uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5
        with:
          fetch-depth: 50  # Increased from 2 to allow merge-base detection
          # Disable unsafe fetch options
          persist-credentials: false

      # Checkout the trusted base commit into a separate path so we do not
      # source code from the PR workspace (untrusted).
      - name: Checkout base commit (trusted sanitizers)
        uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5
        with:
          # Use the base commit SHA to ensure we fetch the exact trusted version.
          ref: ${{ github.event.pull_request.base.sha }}
          path: base
          fetch-depth: 1
          persist-credentials: false

      - name: Configure Git Environment
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""

      - name: Check for source changes
        id: diffcheck
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail

          git config --add safe.directory "$PWD"
          unset GITHUB_TOKEN || true

          base_sha="${{ github.event.pull_request.base.sha }}"
          head_sha="${{ github.event.pull_request.head.sha }}"

          # Validate that both SHAs look like exact Git commit OIDs (40 hex chars).
          validate_sha() {
            local sha="$1"
            if [[ -z "$sha" ]]; then
              return 1
            fi
            # require exactly 40 hexadecimal characters
            if [[ ! "$sha" =~ ^[0-9a-fA-F]{40}$ ]]; then
              return 1
            fi
            return 0
          }

          if ! validate_sha "$base_sha" || ! validate_sha "$head_sha"; then
            echo "Warning: invalid or missing commit sha(s); skipping diff-based source detection." >&2
            echo "src_changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          base_ref="${{ github.base_ref }}"

          # Avoid fetching refs from user-controllable inputs like ($base_ref)
          case "$base_ref" in master)
              ;;
            *)
              echo "Ref blocked or unsupported: $base_ref" >&2
              echo "src_changed=false" >> "$GITHUB_OUTPUT"
              exit 0
              ;;
          esac

          # Fetch with increased depth to find merge base
          git -c protocol.version=2 fetch --no-tags origin "${base_ref}" --depth=50

          # Check if merge base exists before running diff
          if ! git merge-base "origin/${base_ref}" HEAD >/dev/null 2>&1; then
            echo "Warning: no merge base found between origin/${base_ref} and HEAD; assuming source changed for safety" >&2
            echo "src_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Case-insensitive extension match (c/h/cpp variants)
          if git diff --name-only "origin/${base_ref}"...HEAD |
             grep -Ei '\.(cpp|cxx|cc|c|h|hpp|hh)$' >/dev/null; then
            echo "src_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "src_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate Summary
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
          GH_EVENT_NAME: ${{ github.event_name }}
          GH_REPOSITORY: ${{ github.repository }}
          GH_REF_NAME: ${{ github.ref_name }}
          GH_SHA: ${{ github.sha }}
          GH_ACTOR: ${{ github.actor }}
          GH_RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

          # --- load trusted canonical sanitizers from the checked-out base ---
          TRUSTED_SANITIZER="$GITHUB_WORKSPACE/base/.github/scripts/sanitize-sed.sh"
          if [[ -f "$TRUSTED_SANITIZER" ]]; then
            # source the trusted sanitizer (from the base commit)
            # shellcheck disable=SC1090
            source "$TRUSTED_SANITIZER"
          else
            # Fallback: provide a minimal, safe sanitizer to ensure step summaries
            # are escaped. This is intentionally conservative.
            escape_html() {
              local s="$1"
              s="${s//&/&amp;}"
              s="${s//</&lt;}"
              s="${s//>/&gt;}"
              s="${s//\"/&quot;}"
              s="${s//\'/&#39;}"
              printf '%s' "$s"
            }
            sanitize_print() { escape_html "$1"; }
            sanitize_line() { escape_html "$1"; }
          fi

          {
            echo "<div align=\"center\">"
            echo "  <h3>Welcome to the ICC Development Workflow</h3>"
            echo "  ‚è±Ô∏è <em>Date:</em> $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "</div>"
            echo ""
            echo "## ‚úîÔ∏è PR Checklist"
            echo ""
            echo "- [x] You have followed the [guidelines for contributing](https://github.com/InternationalColorConsortium/iccDEV/blob/master/CONTRIBUTING.md)"
            echo "- [x] Commits follow GitHub‚Äôs [acceptable use policy](https://docs.github.com/en/site-policy/acceptable-use-policies/github-acceptable-use-policies)"
            echo "- [x] You checked for duplicate [pull requests](https://github.com/InternationalColorConsortium/iccDEV/pulls)"
            echo "- [x] You built your PR locally using the official [Build Instructions](https://github.com/InternationalColorConsortium/iccDEV/blob/master/docs/build.md)"
            echo "- [x] You included Unit Tests and/or Issue reproduction steps + fix"
            echo ""
            echo "If you have questions, contact a listed [Maintainer](https://github.com/InternationalColorConsortium/iccDEV/tree/master/.github/CODEOWNERS)."
            echo ""
            echo "## üõ°Ô∏è Legal Requirements"
            echo ""
            echo "All contributions to ICC open-source projects follow:"
            echo "- The [International Color Consortium IP Policy](https://www.color.org/iccip.xalter)"
            echo "- Open-source software best practices"
            echo "- Contributor License Agreement (CLA) requirements"
            echo ""
            echo "### üìÑ Contributor License Agreements"
            echo "Before contributing code, you must complete a **Contributor License Agreement (CLA)**."
            echo ""
            echo "- [üßç Personal CLA](https://github.com/InternationalColorConsortium/.github/blob/main/docs/CLA.md)"
            echo "- [üè¢ Corporate CLA](https://github.com/InternationalColorConsortium/.github/blob/main/docs/icc-individual-cla.pdf)"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

  setup:
    name: üß≠ Thank You for the PR
    runs-on: ubuntu-latest
    needs: [detect-src]
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout repository (for shared sanitize helpers)
        uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Checkout base commit (trusted sanitizers)
        uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base
          fetch-depth: 1
          persist-credentials: false

      - name: Print PR Details
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
          GH_EVENT_NAME: ${{ github.event_name }}
          GH_REPOSITORY: ${{ github.repository }}
          GH_REF_NAME: ${{ github.ref_name }}
          GH_SHA: ${{ github.sha }}
          GH_ACTOR: ${{ github.actor }}
          GH_RUN_ID: ${{ github.run_id }}
          SRC_CHANGED: ${{ needs.detect-src.outputs.src_changed }}
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          # Load canonical sanitizers from trusted checkout
          TRUSTED_SANITIZER="$GITHUB_WORKSPACE/base/.github/scripts/sanitize-sed.sh"
          if [[ -f "$TRUSTED_SANITIZER" ]]; then
            # shellcheck disable=SC1090
            source "$TRUSTED_SANITIZER"
          else
            escape_html() {
              local s="$1"
              s="${s//&/&amp;}"
              s="${s//</&lt;}"
              s="${s//>/&gt;}"
              s="${s//\"/&quot;}"
              s="${s//\'/&#39;}"
              printf '%s' "$s"
            }
            sanitize_print() { escape_html "$1"; }
            sanitize_line() { escape_html "$1"; }
          fi

          echo "============================"
          echo "   iccDEV PR Build Runner   "
          echo "============================"
          echo ""
          echo "International Color Consortium"
          echo "Thank you for the PR"
          echo ""
          echo "Trigger: $(sanitize_print "$GH_EVENT_NAME")"
          echo "Repository: $(sanitize_print "$GH_REPOSITORY")"
          echo "Branch: $(sanitize_print "$GH_REF_NAME")"
          echo "Commit: $(sanitize_print "$GH_SHA")"
          echo "Actor: $(sanitize_print "$GH_ACTOR")"
          echo "Run ID: $(sanitize_print "$GH_RUN_ID")"
          echo "Start time: $(date)"
          echo "Source changed: $(sanitize_print "$SRC_CHANGED")"

      - name: Generate Summary
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
          # ensure these are available in the step; if not, the defaults below will be used
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          SRC_CHANGED: ${{ needs.detect-src.outputs.src_changed || 'false' }}
        run: |
          set -euo pipefail
      
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
      
          # load trusted canonical sanitizers
          TRUSTED_SANITIZER="$GITHUB_WORKSPACE/base/.github/scripts/sanitize-sed.sh"
          if [[ -f "$TRUSTED_SANITIZER" ]]; then
            # shellcheck disable=SC1090
            source "$TRUSTED_SANITIZER"
          else
            escape_html() {
              local s="$1"
              s="${s//&/&amp;}"
              s="${s//</&lt;}"
              s="${s//>/&gt;}"
              s="${s//\"/&quot;}"
              s="${s//\'/&#39;}"
              printf '%s' "$s"
            }
            sanitize_line() { escape_html "$1"; }
            sanitize_print() { escape_html "$1"; }
          fi
      
          # Safe defaults.
          : "${GITHUB_EVENT_NAME:=<none>}"
          : "${GITHUB_REPOSITORY:=<none>}"
          : "${GITHUB_REF_NAME:=<none>}"
          : "${GITHUB_SHA:=<none>}"
          : "${GITHUB_RUN_ID:=<none>}"
          : "${SRC_CHANGED:=false}"
      
          # write step summary (all dynamic values passed through sanitize_line)
          {
            echo "## üß≠ PR Init Complete"
            echo ""
            echo "**Workflow:** ci-pr-action"
            echo "- **GITHUB_Repository:** \`$(sanitize_line "${GITHUB_REPOSITORY}")\`"
            echo "- **Event type:** \`$(sanitize_line "${GITHUB_EVENT_NAME}")\`"
            echo "- **Branch:** \`$(sanitize_line "${GITHUB_REF_NAME}")\`"
            echo "- **Commit:** \`$(sanitize_line "${GITHUB_SHA}")\`"
            echo "- **Run ID:** \`$(sanitize_line "${GITHUB_RUN_ID}")\`"
            echo "- **Session start:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "- **Source changed:** \`$(sanitize_line "${SRC_CHANGED}")\`"
            echo ""
            echo "‚úÖ CI environment successfully initialized and ready for subsequent jobs."
          } >> "$GITHUB_STEP_SUMMARY"

  validate-inputs:
    name: üß≠ Init PR Build Matrix
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    needs: [setup, detect-src]

    outputs:
      os-list: ${{ steps.v.outputs.os }}
      compilers: ${{ steps.v.outputs.comp }}
      build-types: ${{ steps.v.outputs.bt }}

    steps:
      - name: Set up Matrix Runners
        id: v
        shell: bash --noprofile --norc {0}
        run: |
          set -euo pipefail

          # --- Define for child workflows ---
          # Windows is Hardcoded - TODO
          allowed_os=( "ubuntu-latest" "macos-latest" )
          allowed_comp=( "gcc" "clang" )
          allowed_bt=( "Release" "Debug" )
          # --- Define for child workflows ---
          # Windows is Hardcoded - TODO
          os_raw='["ubuntu-latest","macos-latest"]'
          comp_raw='["gcc","clang"]'
          bt_raw='["Release","Debug"]'

          validate() {
            local json="$1"; shift
            local allowed=("$@")

            # ensure jq is present
            if ! command -v jq >/dev/null 2>&1; then
              echo "Error: jq is required for input validation" >&2
              exit 1
            fi

            readarray -t vals < <(jq -r '.[]' <<<"$json")

            for v in "${vals[@]}"; do
              local ok=0
              for a in "${allowed[@]}"; do
                [[ "$v" == "$a" ]] && ok=1
              done
              if [[ $ok -eq 0 ]]; then
                echo "Invalid matrix value: $v" >&2
                exit 1
              fi
            done
          }

          validate "$os_raw"   "${allowed_os[@]}"
          validate "$comp_raw" "${allowed_comp[@]}"
          validate "$bt_raw"   "${allowed_bt[@]}"

          echo "os=$os_raw"   >> "$GITHUB_OUTPUT"
          echo "comp=$comp_raw" >> "$GITHUB_OUTPUT"
          echo "bt=$bt_raw"     >> "$GITHUB_OUTPUT"

  unix-ci:
    if: ${{ needs.detect-src.outputs.src_changed == 'true' }}
    name: üß± Unix Build & Test Profiles
    needs: [setup, detect-src, validate-inputs]
    uses: ./.github/workflows/ci-pr-unix.yml
    # pass minimized inputs
    with:
      # only these, bail if not defined
      os-list: ${{ needs.validate-inputs.outputs.os-list }}
      build-types: ${{ needs.validate-inputs.outputs.build-types }}
      compilers: ${{ needs.validate-inputs.outputs.compilers }}

  lint:
    if: ${{ needs.detect-src.outputs.src_changed == 'true' }}
    name: üßπ Lint & Code Quality
    needs: [setup, detect-src]
    uses: ./.github/workflows/ci-pr-lint.yml
    with:
      ubuntu-version: 'ubuntu-latest'

  scan-build:
    if: ${{ needs.detect-src.outputs.src_changed == 'true' }}
    name: üîç Scan-Build
    needs: [unix-ci, detect-src]
    uses: ./.github/workflows/ci-pr-unix-sb.yml
    with:
      build-type: 'Release'

  win-ci:
    if: ${{ needs.detect-src.outputs.src_changed == 'true' }}
    name: üß± Windows Build & Test Profiles
    needs: [setup, detect-src, validate-inputs]
    uses: ./.github/workflows/ci-pr-win.yml

  finalize:
    name: üßæ PR Summary
    runs-on: ubuntu-latest
    needs:
      - detect-src
      - unix-ci
      - lint
      - scan-build
      - win-ci
    if: always()
    steps:
      - uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5
        with:
          fetch-depth: 2
          persist-credentials: false

      - name: Checkout base commit (trusted sanitizers)
        uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base
          fetch-depth: 1
          persist-credentials: false

      - name: üß≠ PR Details
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          SRC_CHANGED: ${{ needs.detect-src.outputs.src_changed }}
          UNIX_RESULT: ${{ needs.unix-ci.result }}
          LINT_RESULT: ${{ needs.lint.result }}
          SCAN_RESULT: ${{ needs['scan-build'].result }}
          WIN_RESULT: ${{ needs['win-ci'].result }}
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
  
          # load canonical sanitizers from trusted checkout
          TRUSTED_SANITIZER="$GITHUB_WORKSPACE/base/.github/scripts/sanitize-sed.sh"
          if [[ -f "$TRUSTED_SANITIZER" ]]; then
            # shellcheck disable=SC1090
            source "$TRUSTED_SANITIZER"
          else
            escape_html() {
              local s="$1"
              s="${s//&/&amp;}"
              s="${s//</&lt;}"
              s="${s//>/&gt;}"
              s="${s//\"/&quot;}"
              s="${s//\'/&#39;}"
              printf '%s' "$s"
            }
            sanitize_line() { escape_html "$1"; }
            sanitize_print() { escape_html "$1"; }
          fi
  
          # --- normalize upstream job results (default to success if missing) ---
          UNIX_RESULT="${UNIX_RESULT:-success}"
          LINT_RESULT="${LINT_RESULT:-success}"
          SCAN_RESULT="${SCAN_RESULT:-success}"
          WIN_RESULT="${WIN_RESULT:-success}"
  
          # remove CRs, trim whitespace and lowercase each value
          trim_and_norm() {
            local v="$1"
            # remove CRs
            v="${v//$'\r'/}"
            # trim leading/trailing whitespace (awk used for portability)
            v="$(printf '%s' "$v" | awk '{$1=$1;print}')"
            # lowercase (use tr for portability)
            v="$(echo "$v" | tr '[:upper:]' '[:lower:]')"
            printf '%s' "$v"
          }
  
          UNIX_RESULT="$(trim_and_norm "$UNIX_RESULT")"
          LINT_RESULT="$(trim_and_norm "$LINT_RESULT")"
          SCAN_RESULT="$(trim_and_norm "$SCAN_RESULT")"
          WIN_RESULT="$(trim_and_norm "$WIN_RESULT")"
  
          # --- compute overall result from upstream jobs ----------------------
          job_res=success
          for s in "$UNIX_RESULT" "$LINT_RESULT" "$SCAN_RESULT" "$WIN_RESULT"; do
            # 'skipped' is acceptable (jobs are skipped when src_changed is false)
            # only 'failure' or 'cancelled' should cause overall failure
            if [[ "$s" != "success" && "$s" != "skipped" ]]; then
              job_res=failure
              break
            fi
          done
  
          # --- write header ----------------------------------------------------
          {
            echo "<div align=\"center\">"
            echo "  <h3>Completed the ICC Development Workflow</h3>"
            echo "  ‚è±Ô∏è <em>Date:</em> $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "</div>"
            echo ""
            echo "## üß© PR Summary"
            echo "  <strong>PRs Are Typically Reviewed Within 14 Days</strong><br>"
            echo ""
            echo "## üìå PR / Branch Context"
            echo '```text'
            printf "HEAD_REF:   %s\n" "$(sanitize_line "${GITHUB_HEAD_REF:-<none>}")"
            printf "BASE_REF:   %s\n" "$(sanitize_line "${GITHUB_BASE_REF:-<none>}")"
            printf "GITHUB_REF: %s\n" "$(sanitize_line "${GITHUB_REF:-<none>}")"
            echo '```'
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          # --- write job status summary ---------------------------------------
          {
            echo "## üõ†Ô∏è Job Status"
            echo ""
            echo "| Job                | Status   |"
            echo "|--------------------|----------|"
            printf "| unix-ci            | %s |\n" "$(sanitize_line "$UNIX_RESULT")"
            printf "| lint               | %s |\n" "$(sanitize_line "$LINT_RESULT")"
            printf "| scan-build         | %s |\n" "$(sanitize_line "$SCAN_RESULT")"
            printf "| win-ci             | %s |\n" "$(sanitize_line "$WIN_RESULT")"
            echo ""
            echo "**Overall Result:** \`$(sanitize_line "$job_res")\`"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"
